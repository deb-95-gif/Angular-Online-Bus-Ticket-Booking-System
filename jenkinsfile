pipeline {
      agent any
      stages {
       stage('Cloning Git') {
         steps {
            checkout scm
            }
       }
  /*
stage(' adding user') {
      steps {
           script{
              sudo groupadd docker
              sudo usermod -aG docker $USER
              sudo newgrp docker
             }
            }
         } 
   */      
        stage('Build images') {
	      steps {
		script {
        cd app
			  docker build -f "Dockerfile" -t 1995bhowmick/angular-online-bus-ticket-booking-system .
		       }
	      }
       }
   
     stage('Push Docker image') {
	  steps{
		    withDockerRegistry([ credentialsId: "Docker_Hub", url: "" ]){
			
			  sh "docker push 1995bhowmick/angular-online-bus-ticket-booking-system:latest"   
	  	   }
	   }
       } 
       stage('Deploy On Aws'){
	      /* 
	       environment{
		       
		        dockerRun = "docker run -p 8080:8080 -d --name my-app kammana/my-app:2.0.0"
	       }
		*/
    steps{
			sshagent(['dev-server']) {
			sh "ssh -o StrictHostKeyChecking=no ec2-user@3.236.222.156 sudo dokcer run 1995bhowmick/angular-online-bus-ticket-booking-system:latest"
			}
	   	}
   }
   stage('post building') {
      steps{
	      post {
        always {
            //archiveArtifacts artifacts: 'generatedFile.log', onlyIfSuccessful: true
          
            emailext attachLog: true,
                body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}",
                recipientProviders: [developers(), requestor()],
                subject: "Jenkins Build :- ${currentBuild.currentResult}: Job ${env.JOB_NAME}"
                }
              }
          }
      }   
    }
  }
