pipeline {
stage(' adding user') {
      steps {
           script{
              sudo groupadd docker
              sudo usermod -aG docker $USER
              sudo newgrp docker
              }
            }
         }
  environment {
    registry = "1995bhowmick/angular-online-bus-ticket-booking-system"
    registryCredential = 'DOCKER_HUB'
    dockerImage = ''
  }
agent any
  stages {
    stage('Cloning Git') {
    steps {
        checkout scm
   }
 }
 
 stage('Building image') {
      steps{
        script {
          dockerImage = docker.build registry + ":$BUILD_NUMBER"
        }
      }
    }
    stage('Deploy Image') {
      steps{
        script {
          docker.withRegistry( '', registryCredential ) {
            dockerImage.push()
              }
           }
      }
    }
    stage('Remove Unused docker image') {
      steps{
        sh "docker rmi $registry:$BUILD_NUMBER"
      }
    }
   }
  } 
        
   // stage('Install dependencies') {
     //   nodejs('nodejs') {
       //     sh 'npm install'
        //    echo "Modules installed"
      //  }
        
  //  }
  //  stage('Build') {
   //     nodejs('nodejs') {
    //        sh 'ng build --prod'
     //       echo "Build completed"
     //   }
        
  //  }

  //  stage('Package Build') {
   //     sh "tar -zcvf bundle.tar.gz dist/Angular-Online-Bus-Ticket-Booking-System/"
//    }
    
 //   stage('Artifacts Creation') {
  //      fingerprint 'bundle.tar.gz'
   //     archiveArtifacts 'bundle.tar.gz'
   //     echo "Artifacts created"
   // }

  //  stage('Stash changes') {
  //      stash allowEmpty: true, includes: 'bundle.tar.gz', name: 'buildArtifacts'
  //  }

//stage('Approval') {
            // no agent, so executors are not used up when waiting for approvals
            //agent none
           // steps {
  //              script {
    //                def deploymentDelay = input id: 'Deploy', message: 'Deploy to production?', submitter: 'rkivisto,admin', parameters: [choice(choices: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'], description: 'Hours to delay deployment?', name: 'deploymentDelay')]
      //              sleep time: deploymentDelay.toInteger(), unit: 'HOURS'
             //   }
       //     }
     //   }
        
       //  stage('Deploy'){
         //             sh 'pm2 restart all'
        // }
     
  //   stage('Build images') {
	 //    steps {
//		script {
//			  cd app//
		//	  docker build -f "Dockerfile" -t 1995bhowmick/angular-online-bus-ticket-booking-system
//		 }
 //    }
 //   }
 //    stage('Push Docker image') {
	//  steps{
	//	    withDockerRegistry([ credentialsId: "Docker_Hub", url: "" ]){
			
		//	sh "docker push 1995bhowmick/angular-online-bus-ticket-booking-system:latest"   
	  //	   }
	//   }
//       } 
 //   }
// node('awsnode') {
//    echo 'Unstash'
//    unstash 'buildArtifacts'
 //   echo 'Artifacts copied'

//    echo 'Copy'
//    sh "yes | sudo cp -R bundle.tar.gz /var/www/html && cd /var/www/html && sudo tar -xvf bundle.tar.gz"
 //   echo 'Copy completed'
// }
